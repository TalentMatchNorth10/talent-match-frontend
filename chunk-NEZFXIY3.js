import{a as p}from"./chunk-MEU3TBTC.js";import{a as u,b as k}from"./chunk-JEUZITVV.js";import{c as E}from"./chunk-H32CEN7X.js";import{f as v}from"./chunk-5YWPRN7E.js";import{$ as c,A as f,E as S,H as g,P as l,S as T,W as a,aa as o,g as d,l as h,y as m}from"./chunk-VREVKPXB.js";var P=[{pattern:"/api/auth/refresh",methods:["POST"]},{pattern:"/api/shop/cart",methods:["GET","DELETE","POST"]},{pattern:"/api/shop/order",methods:["GET"]},{pattern:"/api/student/purchased_courses",methods:["GET"]},{pattern:"/api/student_reservation/reserve_course",methods:["POST"]},{pattern:"/api/student_reservation/reserves_time",methods:["POST"]},{pattern:"/api/favorites",methods:["POST"]},{pattern:"/api/upload/file",methods:["POST"]},{pattern:"/api/teacher_course",methods:["GET","POST"]},{pattern:"/api/teacher_video",methods:["GET","POST"]},{pattern:"/api/file",methods:["POST","GET","DELETE"]}];var D=(()=>{let t=class t{constructor(){this.authService=o(E),this.storageService=o(u),this.authStatusService=o(k),this.router=o(v),this.isRefreshing=!1,this.refreshTokenSubject=new d(null)}intercept(e,r){return this.isProtectedRoute(e.url,e.method)?r.handle(e).pipe(f(i=>i.status===401?this.handle401Error(e,r):(i.status===500&&this.logout(),h(()=>i)))):r.handle(e)}isProtectedRoute(e,r){return P.some(i=>new RegExp(i.pattern).test(e)&&i.methods.includes(r))}handle401Error(e,r){let i=this.storageService.getSessionItem("refresh_token");return i?this.isRefreshing?this.refreshTokenSubject.pipe(m(n=>n!==null),S(1),l(()=>r.handle(this.addToken(e)))):(this.isRefreshing=!0,this.refreshTokenSubject.next(null),this.authService.apiAuthRefreshPost({refreshRequestModel:{refresh_token:i}}).pipe(T(n=>{this.authStatusService.setLoginStatus(n.data),this.refreshTokenSubject.next(n.data.access_token),this.isRefreshing=!1}),l(()=>r.handle(this.addToken(e))),f(()=>(this.isRefreshing=!1,this.logout(),h(()=>new Error("Session expired, please log in again")))))):(this.logout(),h(()=>new Error("No refresh token available, logging out")))}addToken(e){let r=this.storageService.getSessionItem("access_token");return e.clone({setHeaders:{Authorization:`Bearer ${r}`}})}logout(){this.authStatusService.logout(),this.router.navigate(["/login"])}};t.\u0275fac=function(r){return new(r||t)},t.\u0275prov=a({token:t,factory:t.\u0275fac});let s=t;return s})();var _=(()=>{let t=class t{constructor(e){this.loadingService=e}intercept(e,r){let i=o(p);return i.showLoading(),r.handle(e).pipe(g(()=>i.hideLoading()))}};t.\u0275fac=function(r){return new(r||t)(c(p))},t.\u0275prov=a({token:t,factory:t.\u0275fac});let s=t;return s})();var J=(()=>{let t=class t{constructor(e){this.storageService=e}intercept(e,r){let i=this.storageService.getSessionItem("access_token");return i&&(e=e.clone({setHeaders:{Authorization:`Bearer ${i}`}})),r.handle(e)}};t.\u0275fac=function(r){return new(r||t)(c(u))},t.\u0275prov=a({token:t,factory:t.\u0275fac});let s=t;return s})();export{D as a,_ as b,J as c};
